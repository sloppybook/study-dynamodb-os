dynamodb-pipeline:
  source:
    dynamodb:
      tables:
        - table_arn: "arn:aws:dynamodb:us-east-1:000000000000:table/test-table"
          stream_arn: "arn:aws:dynamodb:us-east-1:000000000000:table/test-table/stream/2025-07-12T06:04:20.925"
          export:
            s3_bucket: "test-bucket"
            s3_region: "us-east-1"
            s3_prefix: "dynamodb-export/"
      aws:
        region: "us-east-1"
        sts_role_arn: ""
        sts_external_id: ""
        sts_header_overrides: {}
      s3:
        region: "us-east-1"
      stream:
        initial_position: "LATEST"
      coordination:
        partition_count: 1
      # LocalStack用の設定
      aws_endpoint_override: "http://localstack:4566"

  processor:
    - parse_json:
        source: "dynamodb_json"
        destination: "parsed_data"
    - add_entries:
        entries:
          - key: "timestamp"
            value: "#{/eventSourceARN}"
          - key: "operation"
            value: "#{/eventName}"
    - delete_entries:
        with_keys:
          - "awsRegion"
          - "eventSourceARN"
          - "eventSource"
          - "eventVersion"
          - "eventID"
          - "userIdentity"

  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "dynamodb-cdc"
        index_type: "_doc"
        template_type: "index-template"
        template_file: ""
        document_id_field: "dynamodb.Keys.id.S"
        action: "#{getMetadata(\"opensearch_action\")}"
        flush_timeout: 1000
        bulk_size: 100
